!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";var indentingTags=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log"];CodeMirror.defineMode("soy",function(config){var textMode=CodeMirror.getMode(config,"text/plain"),modes={html:CodeMirror.getMode(config,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1}),attributes:textMode,text:textMode,uri:textMode,trusted_resource_uri:textMode,css:CodeMirror.getMode(config,"text/css"),js:CodeMirror.getMode(config,{name:"text/javascript",statementIndent:2*config.indentUnit})};function last(array){return array[array.length-1]}function tokenUntil(stream,state,untilRegExp){if(stream.sol()){for(var indent=0;indent<state.indent&&stream.eat(/\s/);indent++);if(indent)return null}var oldString=stream.string,match=untilRegExp.exec(oldString.substr(stream.pos));match&&(stream.string=oldString.substr(0,stream.pos+match.index));var result=stream.hideFirstChars(state.indent,function(){var localState=last(state.localStates);return localState.mode.token(stream,localState.state)});return stream.string=oldString,result}function prepend(list,element){return{element:element,next:list}}function ref(list,name,loose){return function(list,element){for(;list;){if(list.element===element)return!0;list=list.next}return!1}(list,name)?"variable-2":loose?"variable":"variable-2 error"}function popscope(state){state.scopes&&(state.variables=state.scopes.element,state.scopes=state.scopes.next)}return{startState:function(){return{kind:[],kindTag:[],soyState:[],templates:null,variables:prepend(null,"ij"),scopes:null,indent:0,quoteKind:null,localStates:[{mode:modes.html,state:CodeMirror.startState(modes.html)}]}},copyState:function(state){return{tag:state.tag,kind:state.kind.concat([]),kindTag:state.kindTag.concat([]),soyState:state.soyState.concat([]),templates:state.templates,variables:state.variables,scopes:state.scopes,indent:state.indent,quoteKind:state.quoteKind,localStates:state.localStates.map(function(localState){return{mode:localState.mode,state:CodeMirror.copyState(localState.mode,localState.state)}})}},token:function(stream,state){switch(last(state.soyState)){case"comment":if(stream.match(/^.*?\*\//)?state.soyState.pop():stream.skipToEnd(),!state.scopes)for(var paramRe=/@param\??\s+(\S+)/g,current=stream.current();match=paramRe.exec(current);)state.variables=prepend(state.variables,match[1]);return"comment";case"string":var match;return(match=stream.match(/^.*?(["']|\\[\s\S])/))?match[1]==state.quoteKind&&(state.quoteKind=null,state.soyState.pop()):stream.skipToEnd(),"string"}if(stream.match(/^\/\*/))return state.soyState.push("comment"),"comment";if(stream.match(stream.sol()||state.soyState.length&&"literal"!=last(state.soyState)?/^\s*\/\/.*/:/^\s+\/\/.*/))return"comment";switch(last(state.soyState)){case"templ-def":return(match=stream.match(/^\.?([\w]+(?!\.[\w]+)*)/))?(state.templates=prepend(state.templates,match[1]),state.scopes=prepend(state.scopes,state.variables),state.soyState.pop(),"def"):(stream.next(),null);case"templ-ref":return(match=stream.match(/^\.?([\w]+)/))?(state.soyState.pop(),"."==match[0][0]?ref(state.templates,match[1],!0):"variable"):(stream.next(),null);case"param-def":return(match=stream.match(/^\w+/))?(state.variables=prepend(state.variables,match[0]),state.soyState.pop(),state.soyState.push("param-type"),"def"):(stream.next(),null);case"param-type":return"}"==stream.peek()?(state.soyState.pop(),null):stream.eatWhile(/^[\w]+/)?"variable-3":(stream.next(),null);case"var-def":return(match=stream.match(/^\$([\w]+)/))?(state.variables=prepend(state.variables,match[1]),state.soyState.pop(),"def"):(stream.next(),null);case"tag":if(stream.match(/^\/?}/))return"/template"==state.tag||"/deltemplate"==state.tag?(popscope(state),state.variables=prepend(null,"ij"),state.indent=0):("/for"!=state.tag&&"/foreach"!=state.tag||popscope(state),state.indent-=config.indentUnit*("/}"==stream.current()||-1==indentingTags.indexOf(state.tag)?2:1)),state.soyState.pop(),"keyword";if(stream.match(/^([\w?]+)(?==)/)){if("kind"==stream.current()&&(match=stream.match(/^="([^"]+)/,!1))){var kind=match[1];state.kind.push(kind),state.kindTag.push(state.tag);var mode=modes[kind]||modes.html;(localState=last(state.localStates)).mode.indent&&(state.indent+=localState.mode.indent(localState.state,"")),state.localStates.push({mode:mode,state:CodeMirror.startState(mode)})}return"attribute"}return(match=stream.match(/^["']/))?(state.soyState.push("string"),state.quoteKind=match,"string"):(match=stream.match(/^\$([\w]+)/))?ref(state.variables,match[1]):(match=stream.match(/^\w+/))?/^(?:as|and|or|not|in)$/.test(match[0])?"keyword":null:(stream.next(),null);case"literal":return stream.match(/^(?=\{\/literal})/)?(state.indent-=config.indentUnit,state.soyState.pop(),this.token(stream,state)):tokenUntil(stream,state,/\{\/literal}/)}if(stream.match(/^\{literal}/))return state.indent+=config.indentUnit,state.soyState.push("literal"),"keyword";if(match=stream.match(/^\{([\/@\\]?\w+\??)(?=[\s\}]|\/[/*])/)){var localState;if("/switch"!=match[1]&&(state.indent+=(/^(\/|(else|elseif|ifempty|case|fallbackmsg|default)$)/.test(match[1])&&"switch"!=state.tag?1:2)*config.indentUnit),state.tag=match[1],state.tag=="/"+last(state.kindTag))state.kind.pop(),state.kindTag.pop(),state.localStates.pop(),(localState=last(state.localStates)).mode.indent&&(state.indent-=localState.mode.indent(localState.state,""));return state.soyState.push("tag"),"template"==state.tag||"deltemplate"==state.tag?state.soyState.push("templ-def"):"call"==state.tag||"delcall"==state.tag?state.soyState.push("templ-ref"):"let"==state.tag?state.soyState.push("var-def"):"for"==state.tag||"foreach"==state.tag?(state.scopes=prepend(state.scopes,state.variables),state.soyState.push("var-def")):"namespace"==state.tag?state.scopes||(state.variables=prepend(null,"ij")):state.tag.match(/^@(?:param\??|inject)/)&&state.soyState.push("param-def"),"keyword"}return stream.eat("{")?(state.tag="print",state.indent+=2*config.indentUnit,state.soyState.push("tag"),"keyword"):tokenUntil(stream,state,/\{|\s+\/\/|\/\*/)},indent:function(state,textAfter){var indent=state.indent,top=last(state.soyState);if("comment"==top)return CodeMirror.Pass;if("literal"==top)/^\{\/literal}/.test(textAfter)&&(indent-=config.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(textAfter))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(textAfter)&&(indent-=config.indentUnit),"switch"!=state.tag&&/^\{(case|default)\b/.test(textAfter)&&(indent-=config.indentUnit),/^\{\/switch\b/.test(textAfter)&&(indent-=config.indentUnit)}var localState=last(state.localStates);return indent&&localState.mode.indent&&(indent+=localState.mode.indent(localState.state,textAfter)),indent},innerMode:function(state){return state.soyState.length&&"literal"!=last(state.soyState)?null:last(state.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed"),CodeMirror.registerHelper("hintWords","soy",indentingTags.concat(["delpackage","namespace","alias","print","css","debugger"])),CodeMirror.defineMIME("text/x-soy","soy")});